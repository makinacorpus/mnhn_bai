<% layout('base') -%>

<input type='hidden' name='_csrf' id='_csrf' value='<%= _csrf %>'>

<% if(medias_pictures.length > 0) { %>
<div class="bloc_img_detail">
    <% if(medias_pictures) { %>
        <div id="mediaCarousel" class="carousel slide" data-ride="carousel">
            
        <!-- Indicators -->
        <ol class="carousel-indicators">
            <% medias_pictures.forEach(function(media, index) {%>
                <li data-target="#mediaCarousel" data-slide-to="<%= index %>" <% if (index == 0) {%>class="active"<%}%>></li>
            <% }); %>
        </ol>
        
        <div class="carousel-inner">
            <% medias_pictures.forEach(function(media, index) {%>
                <div class="item <% if (index == 0) {%>active<%}%>">
                    <img src="<%= media.getUrl() %>" alt="<%= media.getTitle() %>">
                    <div class="container">
                        <div class="carousel-caption">
                            <h1><%= media.getTitle() %></h1>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
        <a class="left carousel-control" href="#mediaCarousel" role="button" data-slide="prev"><span class="glyphicon glyphicon-chevron-left"></span></a>
        <a class="right carousel-control" href="#mediaCarousel" role="button" data-slide="next"><span class="glyphicon glyphicon-chevron-right"></span></a>
        
        </div><!-- /.carousel -->
    <% } else { %>
        <img src="<%= obj.getMainImg() %>" alt="<%= obj.getTitle() %>" />
    <% } %>
</div>
<% } %>


<div class="col-lg-12 col-lg-6-desc main-description">
    
<% if (isAdmin) {%>
    <div class="edit"><a href="/admin/edit_object/<%= obj.getId() %>"><%= __('Edit object') %></a></div>
<% }%>
  
    <div class="bloc_desc">
        <h1><%= obj.getTitle() %></h1>
        <% if(obj.hasShortDesc()) { %>
            <div class="short-description">
                <%= obj.getShortDesc() %>
            </div>
        <% } %>
        
        <% if(obj.hasCompleteDesc()) { %>
            <div class="complete-description">
                <p><%= obj.getCompleteDesc() %></p>
            </div>
        <% } %>          
    
    </div>
</div>


<div class="col-lg-6 col-lg-6-desc view-3D">
    <div class="bloc_desc">
        <div class="header_block"><h4><%= __('3D view') %></h4></div>
        <% include 3dhop.ejs %>
    </div>
</div>

<% if(obj.hasFlat()) { %>
    <div class="col-lg-6 col-lg-6-desc view-flat">
        <div class="bloc_desc">
            <div class="header_block"><h4><%= __('Flat view') %></h4></div>
            <% include flat.ejs %>
        </div>
    </div>
<% } %>

  

<% if(medias.length > 0) { %>
<div class="col-lg-6 col-lg-6-desc">
    <div class="bloc_desc">
        <div class="header_block"><h4><%= __('Medias associated') %></h4></div>
        <ul>
        <% medias.forEach(function(media, index) {%>
            <li><a target="_blank" href="/download?path=<%= media.getPath() %>"><%= media.getTitle() %></a></li>
        <% }); %>
        </ul>
    </div>
</div>
<% } %>

<div class="col-lg-12 col-lg-12-desc">
    <div class="bloc_desc">
        <div class="header_block"><h4><%= __('Associated objects') %></h4></div>
        <p>TODO</p>
    </div>
</div>

<div class="col-lg-12 col-lg-12-desc">
    <div class="bloc_desc">
        <div class="header_block"><h4><%= __('Comments') %></h4></div>
        <div id="comments">
        </div>
        
        <% if (req.isAuthenticated()) { %>
            <textarea name="add_comment" id="add_comment" rows="5" cols="40"><%= __('Add your comment here') %></textarea>
            <button onclick="addComment()"><%= __('Add comment') %></button>
        <% } %>
    </div>
</div>


<script type="text/javascript">

    <% if(medias_pictures.length == 0) { %>
        // If no media pictures, we need to remove the margin of the first blocks
        if($('.main-description')) {
            $('.main-description').css( "margin-top", "0" );
        }
    <% } %>

    $(document).ready(function(){
        $.ajax({
            type: "GET",
            url: "/comments/" + <%= obj.getId() %>,
            data: { "_csrf": $("#_csrf").val() }
        })
        .done(function( comments ) {
            comments.forEach(function(comment, index) {
                $("#comments").append(formatComment(comment.comment, comment.updated, comment.author));
            });
        });
    });
    
    function addComment() {
        comment = $("#add_comment").val();
            
        $.ajax({
            type: "POST",
            url: "/add_comment",
            data: { "comment": comment, "id": <%= obj.getId() %>, "_csrf": $("#_csrf").val()}
        })
        .done(function( msg ) {
            if(msg.status) {
                $("#comments").append(formatComment(comment));
            }
        });
    }
    
    function formatComment(comment, updated, author) {
        var comment = "<div class='comment'><div class='comment_content'>"+comment+"</div><div class='author'><%= __('By') %> "+author+" - " + updated + "</div></div>";
        return comment;
    }
    
</script>
